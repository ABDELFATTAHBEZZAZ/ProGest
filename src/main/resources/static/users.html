<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utilisateurs - Gestion Commerciale</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>

<body>
    <nav class="sidebar">
        <div class="sidebar-header"><i class="bi bi-briefcase-fill"></i>
            <h2>Gestion Commerciale</h2>
        </div>
        <div class="sidebar-nav">
            <div class="nav-section">Menu Principal</div>
            <a href="dashboard.html" class="nav-item"><i class="bi bi-speedometer2"></i><span>Tableau de bord</span></a>
            <a href="clients.html" class="nav-item"><i class="bi bi-people"></i><span>Clients</span></a>
            <a href="produits.html" class="nav-item"><i class="bi bi-box-seam"></i><span>Produits</span></a>
            <a href="devis.html" class="nav-item"><i class="bi bi-file-text"></i><span>Devis</span></a>
            <a href="factures.html" class="nav-item"><i class="bi bi-receipt"></i><span>Factures</span></a>
            <div class="nav-section">Communication</div>
            <a href="chat.html" class="nav-item"><i class="bi bi-chat-dots"></i><span>Messagerie</span></a>
            <div class="nav-section">Administration</div>
            <a href="users.html" class="nav-item active"><i class="bi bi-person-gear"></i><span>Utilisateurs</span></a>
            <a href="statistics.html" class="nav-item"><i class="bi bi-graph-up"></i><span>Statistiques</span></a>
        </div>
    </nav>

    <main class="main-content">
        <div class="top-bar">
            <h1 class="page-title">Gestion des Utilisateurs</h1>
            <div class="user-menu">
                <div class="dropdown">
                    <div class="user-info" data-bs-toggle="dropdown">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <span id="userName">Admin</span>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="logout()"><i
                                    class="bi bi-box-arrow-right me-2"></i>Déconnexion</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="content-area">
            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="icon primary"><i class="bi bi-people"></i></div>
                        <h3 id="totalUsers">0</h3>
                        <p>Total Utilisateurs</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="icon success"><i class="bi bi-person-check"></i></div>
                        <h3 id="connectedUsers">0</h3>
                        <p>Connectés</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="icon warning"><i class="bi bi-shield-check"></i></div>
                        <h3 id="adminUsers">0</h3>
                        <p>Administrateurs</p>
                    </div>
                </div>
            </div>

            <div class="data-card">
                <div class="data-card-header">
                    <h3><i class="bi bi-person-gear me-2"></i>Liste des Utilisateurs</h3>
                    <button class="btn btn-primary" onclick="openModal()">
                        <i class="bi bi-plus-lg me-2"></i>Nouvel Utilisateur
                    </button>
                </div>
                <div class="data-card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Utilisateur</th>
                                    <th>Email</th>
                                    <th>Rôle</th>
                                    <th>Statut</th>
                                    <th>Connexion</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <tr>
                                    <td colspan="6" class="text-center">Chargement...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Nouvel Utilisateur</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="userForm" onsubmit="return saveUser(event)">
                    <div class="modal-body">
                        <input type="hidden" id="userId">
                        <div class="mb-3">
                            <label class="form-label">Nom d'utilisateur *</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="email">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nom complet</label>
                            <input type="text" class="form-control" id="fullName">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mot de passe <span id="pwdHint">(laisser vide pour ne pas
                                    modifier)</span></label>
                            <input type="password" class="form-control" id="password">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Rôle</label>
                            <select class="form-select" id="role">
                                <option value="UTILISATEUR">Utilisateur</option>
                                <option value="ADMIN">Administrateur</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        if (!protectAdminPage()) throw new Error('Not admin');

        let users = [];
        let userModal;

        document.addEventListener('DOMContentLoaded', async function () {
            const user = getCurrentUser();
            document.getElementById('userName').textContent = user.username;
            document.getElementById('userAvatar').textContent = user.username.charAt(0).toUpperCase();
            userModal = new bootstrap.Modal(document.getElementById('userModal'));
            await loadUsers();
        });

        async function loadUsers() {
            try {
                users = await apiCall('/api/users') || [];
                renderUsers();
                updateStats();
            } catch (e) { showToast('Erreur chargement', 'danger'); }
        }

        function renderUsers() {
            const tbody = document.getElementById('usersTable');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Aucun utilisateur</td></tr>';
                return;
            }
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>
                        <strong>${u.username}</strong>
                        ${u.fullName ? `<br><small class="text-muted">${u.fullName}</small>` : ''}
                    </td>
                    <td>${u.email || '-'}</td>
                    <td><span class="badge ${u.role === 'ADMIN' ? 'bg-primary' : 'bg-secondary'}">${u.role}</span></td>
                    <td><span class="status-badge ${u.enabled ? 'accepte' : 'refuse'}">${u.enabled ? 'Actif' : 'Inactif'}</span></td>
                    <td>
                        <span class="online-indicator ${u.connected ? 'online' : 'offline'}"></span>
                        ${u.connected ? 'En ligne' : 'Hors ligne'}
                    </td>
                    <td>
                        <button class="action-btn edit" onclick="editUser(${u.id})" title="Modifier"><i class="bi bi-pencil"></i></button>
                        <button class="action-btn ${u.enabled ? 'delete' : 'view'}" onclick="toggleStatus(${u.id})" title="${u.enabled ? 'Désactiver' : 'Activer'}">
                            <i class="bi bi-${u.enabled ? 'x-circle' : 'check-circle'}"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteUser(${u.id})" title="Supprimer"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function updateStats() {
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('connectedUsers').textContent = users.filter(u => u.connected).length;
            document.getElementById('adminUsers').textContent = users.filter(u => u.role === 'ADMIN').length;
        }

        function openModal(user = null) {
            document.getElementById('modalTitle').textContent = user ? 'Modifier Utilisateur' : 'Nouvel Utilisateur';
            document.getElementById('userId').value = user?.id || '';
            document.getElementById('username').value = user?.username || '';
            document.getElementById('username').disabled = !!user;
            document.getElementById('email').value = user?.email || '';
            document.getElementById('fullName').value = user?.fullName || '';
            document.getElementById('password').value = '';
            document.getElementById('password').required = !user;
            document.getElementById('pwdHint').style.display = user ? '' : 'none';
            document.getElementById('role').value = user?.role || 'UTILISATEUR';
            userModal.show();
        }

        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (user) openModal(user);
        }

        async function saveUser(event) {
            event.preventDefault();
            const id = document.getElementById('userId').value;
            const data = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                fullName: document.getElementById('fullName').value,
                password: document.getElementById('password').value,
                role: document.getElementById('role').value
            };

            if (!id && !data.password) {
                showToast('Mot de passe requis', 'warning');
                return false;
            }

            try {
                if (id) {
                    await apiCall(`/api/users/${id}`, { method: 'PUT', body: data });
                    if (data.role) await apiCall(`/api/users/${id}/role?role=${data.role}`, { method: 'PUT' });
                    showToast('Utilisateur modifié');
                } else {
                    await apiCall('/api/users', { method: 'POST', body: data });
                    showToast('Utilisateur créé');
                }
                userModal.hide();
                await loadUsers();
            } catch (error) {
                showToast(error.message, 'danger');
            }
            return false;
        }

        async function toggleStatus(id) {
            try {
                await apiCall(`/api/users/${id}/toggle-status`, { method: 'PUT' });
                showToast('Statut modifié');
                await loadUsers();
            } catch (e) { showToast('Erreur', 'danger'); }
        }

        async function deleteUser(id) {
            if (await confirmAction('Supprimer cet utilisateur ?')) {
                try {
                    await apiCall(`/api/users/${id}`, { method: 'DELETE' });
                    showToast('Utilisateur supprimé');
                    await loadUsers();
                } catch (e) { showToast('Erreur', 'danger'); }
            }
        }
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clients - Gestion Commerciale</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>

<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <i class="bi bi-briefcase-fill"></i>
            <h2>Gestion Commerciale</h2>
        </div>
        <div class="sidebar-nav">
            <div class="nav-section">Menu Principal</div>
            <a href="dashboard.html" class="nav-item"><i class="bi bi-speedometer2"></i><span>Tableau de bord</span></a>
            <a href="clients.html" class="nav-item active"><i class="bi bi-people"></i><span>Clients</span></a>
            <a href="produits.html" class="nav-item"><i class="bi bi-box-seam"></i><span>Produits</span></a>
            <a href="devis.html" class="nav-item"><i class="bi bi-file-text"></i><span>Devis</span></a>
            <a href="factures.html" class="nav-item"><i class="bi bi-receipt"></i><span>Factures</span></a>
            <div class="nav-section">Communication</div>
            <a href="chat.html" class="nav-item"><i class="bi bi-chat-dots"></i><span>Messagerie</span></a>
            <div class="nav-section admin-only" id="adminSection" style="display:none;">Administration</div>
            <a href="users.html" class="nav-item admin-only" id="usersLink" style="display:none;"><i
                    class="bi bi-person-gear"></i><span>Utilisateurs</span></a>
            <a href="statistics.html" class="nav-item admin-only" id="statsLink" style="display:none;"><i
                    class="bi bi-graph-up"></i><span>Statistiques</span></a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="top-bar">
            <h1 class="page-title">Gestion des Clients</h1>
            <div class="user-menu">
                <div class="dropdown">
                    <div class="user-info" data-bs-toggle="dropdown">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <span id="userName">Utilisateur</span>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="logout()"><i
                                    class="bi bi-box-arrow-right me-2"></i>Déconnexion</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="content-area">
            <div class="data-card">
                <div class="data-card-header">
                    <div class="d-flex align-items-center gap-3">
                        <h3><i class="bi bi-people me-2"></i>Liste des Clients</h3>
                        <div class="search-box">
                            <i class="bi bi-search"></i>
                            <input type="text" class="form-control" id="searchInput" placeholder="Rechercher..."
                                oninput="filterClients()">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="openModal()">
                        <i class="bi bi-plus-lg me-2"></i>Nouveau Client
                    </button>
                </div>
                <div class="data-card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Email</th>
                                    <th>Téléphone</th>
                                    <th>Ville</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="clientsTable">
                                <tr>
                                    <td colspan="5" class="text-center">Chargement...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Client Modal -->
    <div class="modal fade" id="clientModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Nouveau Client</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="clientForm" onsubmit="return saveClient(event)">
                    <div class="modal-body">
                        <input type="hidden" id="clientId">
                        <div class="mb-3">
                            <label class="form-label">Nom *</label>
                            <input type="text" class="form-control" id="nom" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="email">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Téléphone</label>
                            <input type="tel" class="form-control" id="telephone">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Adresse</label>
                            <input type="text" class="form-control" id="adresse">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ville</label>
                                <input type="text" class="form-control" id="ville">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Code Postal</label>
                                <input type="text" class="form-control" id="codePostal">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Pays</label>
                            <input type="text" class="form-control" id="pays" value="France">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        if (!protectPage()) throw new Error('Not authenticated');

        let clients = [];
        let clientModal;

        document.addEventListener('DOMContentLoaded', async function () {
            const user = getCurrentUser();
            document.getElementById('userName').textContent = user.username;
            document.getElementById('userAvatar').textContent = user.username.charAt(0).toUpperCase();

            if (isAdmin()) {
                document.getElementById('adminSection').style.display = '';
                document.getElementById('usersLink').style.display = '';
                document.getElementById('statsLink').style.display = '';
            }

            clientModal = new bootstrap.Modal(document.getElementById('clientModal'));
            await loadClients();
        });

        async function loadClients() {
            try {
                clients = await apiCall('/api/clients') || [];
                renderClients(clients);
            } catch (error) {
                showToast('Erreur lors du chargement', 'danger');
            }
        }

        function renderClients(data) {
            const tbody = document.getElementById('clientsTable');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Aucun client</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(c => `
                <tr>
                    <td><strong>${c.nom}</strong></td>
                    <td>${c.email || '-'}</td>
                    <td>${c.telephone || '-'}</td>
                    <td>${c.ville || '-'}</td>
                    <td>
                        <button class="action-btn edit" onclick="editClient(${c.id})" title="Modifier">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteClient(${c.id})" title="Supprimer">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function filterClients() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = clients.filter(c =>
                c.nom.toLowerCase().includes(search) ||
                (c.email && c.email.toLowerCase().includes(search))
            );
            renderClients(filtered);
        }

        function openModal(client = null) {
            document.getElementById('modalTitle').textContent = client ? 'Modifier Client' : 'Nouveau Client';
            document.getElementById('clientId').value = client?.id || '';
            document.getElementById('nom').value = client?.nom || '';
            document.getElementById('email').value = client?.email || '';
            document.getElementById('telephone').value = client?.telephone || '';
            document.getElementById('adresse').value = client?.adresse || '';
            document.getElementById('ville').value = client?.ville || '';
            document.getElementById('codePostal').value = client?.codePostal || '';
            document.getElementById('pays').value = client?.pays || 'France';
            clientModal.show();
        }

        function editClient(id) {
            const client = clients.find(c => c.id === id);
            if (client) openModal(client);
        }

        async function saveClient(event) {
            event.preventDefault();
            const id = document.getElementById('clientId').value;
            const data = {
                nom: document.getElementById('nom').value,
                email: document.getElementById('email').value,
                telephone: document.getElementById('telephone').value,
                adresse: document.getElementById('adresse').value,
                ville: document.getElementById('ville').value,
                codePostal: document.getElementById('codePostal').value,
                pays: document.getElementById('pays').value
            };

            try {
                if (id) {
                    await apiCall(`/api/clients/${id}`, { method: 'PUT', body: data });
                    showToast('Client modifié avec succès');
                } else {
                    await apiCall('/api/clients', { method: 'POST', body: data });
                    showToast('Client créé avec succès');
                }
                clientModal.hide();
                await loadClients();
            } catch (error) {
                showToast(error.message, 'danger');
            }
            return false;
        }

        async function deleteClient(id) {
            if (await confirmAction('Supprimer ce client ?')) {
                try {
                    await apiCall(`/api/clients/${id}`, { method: 'DELETE' });
                    showToast('Client supprimé');
                    await loadClients();
                } catch (error) {
                    showToast('Erreur lors de la suppression', 'danger');
                }
            }
        }
    </script>
</body>

</html>